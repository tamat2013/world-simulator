<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™××•×œ×˜×•×¨ ××œ×—××•×ª ×¢×•×œ××™ - ××”×“×•×¨×” ××•×¨×—×‘×ª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-grid {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1400px) {
            .game-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .map-container {
            position: relative;
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            min-height: 600px;
        }

        #worldMap {
            width: 100%;
            height: 600px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 50%, #90EE90 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 3px solid #444;
        }

        .country-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .country-marker:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .country-marker.at-war {
            animation: pulse 1s infinite;
            border-color: #ff0000;
        }

        .country-marker.civil-war {
            animation: civilWarPulse 1s infinite;
            border-color: #ff00ff;
            box-shadow: 0 0 20px #ff00ff;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes civilWarPulse {
            0%, 100% { 
                transform: scale(1) rotate(0deg); 
                border-color: #ff00ff;
            }
            50% { 
                transform: scale(1.15) rotate(180deg); 
                border-color: #ff0000;
            }
        }

        .attack-line {
            position: absolute;
            background: linear-gradient(90deg, #ff0000, #ff6600, #ffaa00);
            pointer-events: none;
            box-shadow: 0 0 10px #ff0000;
        }

        .attack-line.civil-war-line {
            background: linear-gradient(90deg, #ff00ff, #ff0080, #ff00ff);
            box-shadow: 0 0 15px #ff00ff;
        }

        .attack-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            pointer-events: none;
        }

        @keyframes attackPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .section h3 {
            margin-bottom: 10px;
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 5px;
        }

        select, button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        select {
            background: #fff;
            color: #333;
        }

        select[multiple] {
            height: 120px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button.attack {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.defend {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button.retreat {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        button.peace {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }

        .war-info {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff6666;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .civil-war-info {
            background: rgba(255, 0, 255, 0.1);
            border: 2px solid #ff00ff;
        }

        .power-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .power-fill {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .power-fill.attacker {
            background: linear-gradient(90deg, #ff0000, #ff6600);
            float: right;
        }

        .power-fill.defender {
            background: linear-gradient(90deg, #0066ff, #00ccff);
        }

        .power-fill.participant-1 {
            background: linear-gradient(90deg, #ff0000, #ff6600);
        }

        .power-fill.participant-2 {
            background: linear-gradient(90deg, #0066ff, #00ccff);
        }

        .power-fill.participant-3 {
            background: linear-gradient(90deg, #00ff00, #66ff66);
        }

        .power-fill.participant-4 {
            background: linear-gradient(90deg, #ffff00, #ffcc00);
        }

        .power-fill.participant-5 {
            background: linear-gradient(90deg, #ff00ff, #ff66ff);
        }

        .power-fill.participant-6 {
            background: linear-gradient(90deg, #00ffff, #66ffff);
        }

        .status-text {
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
        }

        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .log-entry.civil-war {
            color: #ff00ff;
        }

        .country-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .ai-action {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .disabled {
            opacity: 0.5;
            cursor: not-allowed !important;
        }

        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .rankings-table th {
            background: rgba(255, 215, 0, 0.3);
            padding: 8px;
            text-align: right;
            border-bottom: 2px solid #ffd700;
        }

        .rankings-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rankings-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .rank-medal {
            font-size: 16px;
        }

        .settings-group {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #ffd700;
        }

        .settings-group input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .settings-group input[type="checkbox"] {
            margin-left: 5px;
        }

        .speed-display {
            text-align: center;
            font-weight: bold;
            color: #00ff00;
        }

        .auto-battle-indicator {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            animation: pulse 1s infinite;
            margin: 10px 0;
        }

        .participant-selector {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .participant-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 5px 0;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }

        .remove-participant {
            background: #ff4444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            width: auto;
            margin: 0;
        }

        .add-participant {
            background: #44ff44;
            color: #000;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ×¡×™××•×œ×˜×•×¨ ××œ×—××•×ª ×¢×•×œ××™ - ××”×“×•×¨×” ××•×¨×—×‘×ª ğŸŒ</h1>
        
        <div class="game-grid">
            <div class="control-panel">
                <div class="panel section">
                    <h3>âš™ï¸ ×”×’×“×¨×•×ª ××©×—×§</h3>
                    
                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="allowCivilWar" checked>
                            ××¤×©×¨ ××œ×—××•×ª ××–×¨×—×™×
                        </label>
                    </div>
                    
                    <div class="settings-group">
                        <label>××”×™×¨×•×ª ×§×¨×‘:</label>
                        <input type="range" id="battleSpeed" min="500" max="5000" value="2000" step="100">
                        <div class="speed-display" id="speedDisplay">2.0 ×©× ×™×•×ª</div>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="autoBattle" onchange="toggleAutoBattle()">
                            ×§×¨×‘ ××•×˜×•××˜×™
                        </label>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="showPowerBars" checked onchange="togglePowerBars()">
                            ×”×¦×’ ××“×™ ×›×•×—
                        </label>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="soundEffects" checked>
                            ××¤×§×˜×™ ×§×•×œ (×‘×§×¨×•×‘)
                        </label>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="animatedLines" checked onchange="renderMap()">
                            ×§×•×•×™ ×”×ª×§×¤×” ××•× ×¤×©×™×
                        </label>
                    </div>

                    <div id="autoBattleIndicator" style="display: none;" class="auto-battle-indicator">
                        âš”ï¸ ×§×¨×‘ ××•×˜×•××˜×™ ×¤×¢×™×œ âš”ï¸
                    </div>
                </div>

                <div class="panel section">
                    <h3>âš”ï¸ ××¨×’×Ÿ ××œ×—××”</h3>
                    
                    <div id="participantsList" class="participant-selector">
                        <div class="participant-item">
                            <label style="flex: 1;">××©×ª×ª×£ 1:</label>
                            <select id="participant1" style="width: auto; flex: 2;"></select>
                        </div>
                        <div class="participant-item">
                            <label style="flex: 1;">××©×ª×ª×£ 2:</label>
                            <select id="participant2" style="width: auto; flex: 2;"></select>
                        </div>
                    </div>
                    
                    <button class="add-participant" onclick="addParticipant()">â• ×”×•×¡×£ ××©×ª×ª×£</button>
                    <button class="attack" onclick="startWar()">ğŸ”¥ ×”×ª×—×œ ××œ×—××”</button>
                </div>

                <div class="panel section" id="warControls" style="display: none;">
                    <h3>ğŸ® ×¤×§×•×“×•×ª ×§×¨×‘</h3>
                    <div id="warControlButtons"></div>
                    
                    <div class="war-info" id="warStatus"></div>
                </div>

                <div class="panel section">
                    <h3>ğŸ•Šï¸ ×“×™×¤×œ×•××˜×™×”</h3>
                    <button class="peace" onclick="proposePeace()">â˜®ï¸ ×”×¦×¢ ×©×œ×•×</button>
                    <button class="peace" onclick="surrender()">ğŸ³ï¸ ×›× ×™×¢×”</button>
                    
                    <div class="ai-action" id="aiActions" style="display: none;"></div>
                </div>

                <div class="panel section">
                    <h3>ğŸ“Š ××™×“×¢ ×¢×œ ××“×™× ×”</h3>
                    <div class="country-info" id="countryInfo">
                        ×‘×—×¨ ××“×™× ×” ×‘××¤×” ×œ×¨××•×ª ××™×“×¢
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="map-container">
                    <h3 style="margin-bottom: 15px;">ğŸ—ºï¸ ××¤×ª ×”×¢×•×œ×</h3>
                    <div id="worldMap"></div>
                </div>

                <div class="section" style="margin-top: 20px;">
                    <h3>ğŸ“œ ×™×•××Ÿ ××™×¨×•×¢×™×</h3>
                    <div class="log" id="eventLog"></div>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel section">
                    <h3>ğŸ† ×“×™×¨×•×’ ××“×™× ×•×ª</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="rankings-table" id="rankingsTable">
                            <thead>
                                <tr>
                                    <th>×“×™×¨×•×’</th>
                                    <th>××“×™× ×”</th>
                                    <th>×›×•×—</th>
                                    <th>×¡×˜×˜×•×¡</th>
                                </tr>
                            </thead>
                            <tbody id="rankingsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="panel section">
                    <h3>ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
                    <div class="country-info">
                        <div id="gameStats">
                            <strong>××œ×—××•×ª ×¤×¢×™×œ×•×ª:</strong> <span id="activeWars">0</span><br>
                            <strong>×¡×”"×› ×¡×™×‘×•×‘×™×:</strong> <span id="totalTurns">0</span><br>
                            <strong>××“×™× ×•×ª ×‘××œ×—××”:</strong> <span id="countriesAtWar">0</span><br>
                            <strong>××“×™× ×•×ª ×‘×©×œ×•×:</strong> <span id="countriesAtPeace">24</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // × ×ª×•× ×™ ××“×™× ×•×ª ×¢× ×“×™×¨×•×’ ×›×•×— (1-100)
        const countries = {
            '××¨×”"×‘': { power: 100, flag: 'ğŸ‡ºğŸ‡¸', x: 15, y: 35, color: '#1e40af' },
            '×¡×™×Ÿ': { power: 95, flag: 'ğŸ‡¨ğŸ‡³', x: 75, y: 40, color: '#dc2626' },
            '×¨×•×¡×™×”': { power: 90, flag: 'ğŸ‡·ğŸ‡º', x: 60, y: 25, color: '#16a34a' },
            '×”×•×“×•': { power: 75, flag: 'ğŸ‡®ğŸ‡³', x: 70, y: 50, color: '#ea580c' },
            '×‘×¨×™×˜× ×™×”': { power: 70, flag: 'ğŸ‡¬ğŸ‡§', x: 45, y: 28, color: '#7c3aed' },
            '×¦×¨×¤×ª': { power: 68, flag: 'ğŸ‡«ğŸ‡·', x: 47, y: 32, color: '#0891b2' },
            '×’×¨×× ×™×”': { power: 67, flag: 'ğŸ‡©ğŸ‡ª', x: 50, y: 30, color: '#4338ca' },
            '×™×¤×Ÿ': { power: 65, flag: 'ğŸ‡¯ğŸ‡µ', x: 85, y: 38, color: '#be123c' },
            '×“×¨×•× ×§×•×¨×™××”': { power: 60, flag: 'ğŸ‡°ğŸ‡·', x: 82, y: 42, color: '#059669' },
            '××™×˜×œ×™×”': { power: 55, flag: 'ğŸ‡®ğŸ‡¹', x: 50, y: 36, color: '#0284c7' },
            '×˜×•×¨×§×™×”': { power: 53, flag: 'ğŸ‡¹ğŸ‡·', x: 55, y: 38, color: '#dc2626' },
            '×‘×¨×–×™×œ': { power: 50, flag: 'ğŸ‡§ğŸ‡·', x: 30, y: 65, color: '#16a34a' },
            '×™×©×¨××œ': { power: 48, flag: 'ğŸ‡®ğŸ‡±', x: 54, y: 45, color: '#2563eb' },
            '××™×¨××Ÿ': { power: 45, flag: 'ğŸ‡®ğŸ‡·', x: 62, y: 43, color: '#15803d' },
            '××¦×¨×™×': { power: 42, flag: 'ğŸ‡ªğŸ‡¬', x: 53, y: 48, color: '#b91c1c' },
            '×¡×¤×¨×“': { power: 40, flag: 'ğŸ‡ªğŸ‡¸', x: 44, y: 38, color: '#eab308' },
            '××•×¡×˜×¨×œ×™×”': { power: 38, flag: 'ğŸ‡¦ğŸ‡º', x: 82, y: 75, color: '#0891b2' },
            '×§× ×“×”': { power: 36, flag: 'ğŸ‡¨ğŸ‡¦', x: 18, y: 22, color: '#dc2626' },
            '×¢×¨×‘ ×”×¡×¢×•×“×™×ª': { power: 35, flag: 'ğŸ‡¸ğŸ‡¦', x: 58, y: 48, color: '#16a34a' },
            '××§×¡×™×§×•': { power: 32, flag: 'ğŸ‡²ğŸ‡½', x: 12, y: 48, color: '#15803d' },
            '××¨×’× ×˜×™× ×”': { power: 30, flag: 'ğŸ‡¦ğŸ‡·', x: 28, y: 78, color: '#0891b2' },
            '×“×¨×•× ××¤×¨×™×§×”': { power: 28, flag: 'ğŸ‡¿ğŸ‡¦', x: 52, y: 75, color: '#eab308' },
            '××™× ×“×•× ×–×™×”': { power: 25, flag: 'ğŸ‡®ğŸ‡©', x: 78, y: 62, color: '#dc2626' },
            '×¤×§×™×¡×˜×Ÿ': { power: 23, flag: 'ğŸ‡µğŸ‡°', x: 68, y: 45, color: '#16a34a' }
        };

        let currentWar = null;
        let attackLines = [];
        let warTurns = 0;
        let autoBattleInterval = null;
        let totalTurnsAllWars = 0;
        let participantCount = 2;

        function init() {
            populateSelects();
            renderMap();
            updateRankings();
            updateStats();
            addLog('×”××©×—×§ ××•×›×Ÿ! ××¨×’×Ÿ ××œ×—××” ×¢× 2 ××• ×™×•×ª×¨ ××©×ª×ª×¤×™×');
            
            // Speed slider listener
            document.getElementById('battleSpeed').addEventListener('input', function() {
                const speed = this.value / 1000;
                document.getElementById('speedDisplay').textContent = speed.toFixed(1) + ' ×©× ×™×•×ª';
                if (autoBattleInterval) {
                    stopAutoBattle();
                    startAutoBattle();
                }
            });
        }

        function populateSelects() {
            for (let i = 1; i <= 6; i++) {
                const select = document.getElementById(`participant${i}`);
                if (select) {
                    select.innerHTML = '';
                    Object.keys(countries).sort().forEach(country => {
                        const option = new Option(`${countries[country].flag} ${country} (×›×•×—: ${countries[country].power})`, country);
                        select.add(option);
                    });
                }
            }
        }

        function addParticipant() {
            if (participantCount >= 6) {
                alert('××§×¡×™××•× 6 ××©×ª×ª×¤×™× ×‘××œ×—××”');
                return;
            }
            
            participantCount++;
            const participantsList = document.getElementById('participantsList');
            
            const div = document.createElement('div');
            div.className = 'participant-item';
            div.id = `participant-item-${participantCount}`;
            div.innerHTML = `
                <label style="flex: 1;">××©×ª×ª×£ ${participantCount}:</label>
                <select id="participant${participantCount}" style="width: auto; flex: 2;"></select>
                <button class="remove-participant" onclick="removeParticipant(${participantCount})">âœ–</button>
            `;
            participantsList.appendChild(div);
            
            populateSelects();
        }

        function removeParticipant(num) {
            if (participantCount <= 2) {
                alert('×¦×¨×™×›×™× ×œ×¤×—×•×ª 2 ××©×ª×ª×¤×™× ×‘××œ×—××”');
                return;
            }
            
            const item = document.getElementById(`participant-item-${num}`);
            if (item) {
                item.remove();
                participantCount--;
                
                // Renumber remaining participants
                const items = document.querySelectorAll('.participant-item');
                items.forEach((item, index) => {
                    const label = item.querySelector('label');
                    if (label) label.textContent = `××©×ª×ª×£ ${index + 1}:`;
                });
            }
        }

        function startWar() {
            const participants = [];
            const participantData = {};
            
            // Collect all participants
            for (let i = 1; i <= participantCount; i++) {
                const select = document.getElementById(`participant${i}`);
                if (select && select.value) {
                    participants.push(select.value);
                }
            }
            
            // Check for duplicates (except if civil war is allowed)
            const allowCivilWar = document.getElementById('allowCivilWar').checked;
            const uniqueParticipants = [...new Set(participants)];
            
            if (!allowCivilWar && uniqueParticipants.length !== participants.length) {
                alert('×‘×—×¨×ª ××ª ××•×ª×” ××“×™× ×” ×¤×¢××™×™×! ××¤×©×¨ ××œ×—××•×ª ××–×¨×—×™× ×‘×”×’×“×¨×•×ª ×× ××ª×” ×¨×•×¦×”');
                return;
            }
            
            if (participants.length < 2) {
                alert('×¦×¨×™×š ×œ×¤×—×•×ª 2 ××©×ª×ª×¤×™× ×‘××œ×—××”');
                return;
            }
            
            // Check if this is a civil war
            const isCivilWar = uniqueParticipants.length === 1;
            
            // Initialize participant data
            participants.forEach((country, index) => {
                const key = isCivilWar ? `${country}-×¡×™×¢×”-${index + 1}` : country;
                participantData[key] = {
                    country: country,
                    strength: countries[country].power,
                    morale: 100,
                    isActive: true,
                    originalCountry: country
                };
            });
            
            currentWar = {
                participants: participantData,
                isCivilWar: isCivilWar,
                activeCount: participants.length
            };
            
            warTurns = 0;
            
            if (isCivilWar) {
                addLog(`ğŸ’¥ ××œ×—××ª ××–×¨×—×™× ×¤×¨×¦×” ×‘${uniqueParticipants[0]}! ${participants.length} ×¡×™×¢×•×ª × ×œ×—××•×ª ×¢×œ ×”×©×œ×™×˜×”!`, true);
            } else {
                const countryList = participants.map(c => countries[c].flag + ' ' + c).join(', ');
                addLog(`ğŸ”¥ ××œ×—××” ×¨×‘-××©×ª×ª×¤×™×ª ×”×—×œ×”! ××©×ª×ª×¤×™×: ${countryList}`);
            }
            
            document.getElementById('warControls').style.display = 'block';
            createWarControlButtons();
            updateWarStatus();
            updateRankings();
            updateStats();
            renderMap();
            
            // Start auto-battle if enabled
            if (document.getElementById('autoBattle').checked) {
                startAutoBattle();
                document.getElementById('autoBattleIndicator').style.display = 'block';
            }
        }

        function createWarControlButtons() {
            const container = document.getElementById('warControlButtons');
            container.innerHTML = '';
            
            Object.keys(currentWar.participants).forEach((participantKey, index) => {
                if (!currentWar.participants[participantKey].isActive) return;
                
                const participant = currentWar.participants[participantKey];
                const displayName = currentWar.isCivilWar ? participantKey : participant.country;
                const flag = countries[participant.country].flag;
                
                const buttonGroup = document.createElement('div');
                buttonGroup.style.marginBottom = '15px';
                buttonGroup.innerHTML = `
                    <div style="text-align: center; font-weight: bold; margin-bottom: 5px;">
                        ${flag} ${displayName}
                    </div>
                    <button class="attack" onclick="performAction('${participantKey}', 'attack')">âš”ï¸ ×”×ª×§×£</button>
                    <button class="defend" onclick="performAction('${participantKey}', 'defend')">ğŸ›¡ï¸ ×”×’×Ÿ</button>
                    <button class="retreat" onclick="performAction('${participantKey}', 'retreat')">ğŸƒ × ×¡×•×’</button>
                `;
                container.appendChild(buttonGroup);
            });
        }

        function performAction(participantKey, action, isAuto = false) {
            if (!currentWar || !currentWar.participants[participantKey] || !currentWar.participants[participantKey].isActive) return;

            warTurns++;
            totalTurnsAllWars++;
            
            const participant = currentWar.participants[participantKey];
            const displayName = currentWar.isCivilWar ? participantKey : participant.country;
            const flag = countries[participant.country].flag;
            
            // Get all active opponents
            const opponents = Object.keys(currentWar.participants).filter(key => 
                key !== participantKey && currentWar.participants[key].isActive
            );
            
            if (opponents.length === 0) {
                endWar(participantKey);
                return;
            }
            
            // Select random opponent
            const targetKey = opponents[Math.floor(Math.random() * opponents.length)];
            const target = currentWar.participants[targetKey];
            const targetDisplayName = currentWar.isCivilWar ? targetKey : target.country;
            const targetFlag = countries[target.country].flag;
            
            const powerRatio = participant.strength / target.strength;
            let damage = 0;
            let counterDamage = 0;

            switch(action) {
                case 'attack':
                    damage = 5 + Math.random() * 10 * powerRatio;
                    counterDamage = 3 + Math.random() * 8 * (1/powerRatio);
                    target.strength -= damage;
                    participant.strength -= counterDamage;
                    addLog(`âš”ï¸ ${flag} ${displayName} ×ª×•×§×£ ××ª ${targetFlag} ${targetDisplayName}! × ×’×¨× ${damage.toFixed(1)} × ×–×§, ×•×¡×¤×’ ${counterDamage.toFixed(1)} × ×–×§ ×‘×ª×’×•×‘×”`, currentWar.isCivilWar);
                    break;

                case 'defend':
                    counterDamage = 2 + Math.random() * 5 * (1/powerRatio);
                    participant.strength -= counterDamage;
                    participant.morale += 5;
                    addLog(`ğŸ›¡ï¸ ${flag} ${displayName} ××ª××§×“ ×‘×”×’× ×”. ${targetFlag} ${targetDisplayName} ×× ×¦×œ ×•×ª×•×§×£, × ×’×¨× ${counterDamage.toFixed(1)} × ×–×§`, currentWar.isCivilWar);
                    break;

                case 'retreat':
                    damage = 8 + Math.random() * 12 * (1/powerRatio);
                    participant.strength -= damage;
                    participant.morale -= 15;
                    addLog(`ğŸƒ ${flag} ${displayName} × ×¡×•×’! ${targetFlag} ${targetDisplayName} ×¨×•×“×£ ×•×ª×•×§×£, × ×’×¨× ${damage.toFixed(1)} × ×–×§ ×—××•×¨`, currentWar.isCivilWar);
                    break;
            }

            // Check if participants are eliminated
            checkParticipantElimination();
            
            // AI responses for other participants
            if (!isAuto && currentWar.activeCount > 1) {
                setTimeout(() => aiParticipantsResponse(participantKey), 500);
            }
            
            checkWarEnd();
            updateWarStatus();
            updateRankings();
            updateStats();
        }

        function checkParticipantElimination() {
            Object.keys(currentWar.participants).forEach(key => {
                const participant = currentWar.participants[key];
                if (participant.isActive && (participant.strength <= 0 || participant.morale <= 0)) {
                    participant.isActive = false;
                    currentWar.activeCount--;
                    const displayName = currentWar.isCivilWar ? key : participant.country;
                    const flag = countries[participant.country].flag;
                    addLog(`ğŸ’€ ${flag} ${displayName} ×”×•×‘×¡ ×•×™×¦× ××”××œ×—××”!`, currentWar.isCivilWar);
                }
            });
        }

        function aiParticipantsResponse(skipKey) {
            const activeParticipants = Object.keys(currentWar.participants).filter(key => 
                key !== skipKey && currentWar.participants[key].isActive
            );
            
            activeParticipants.forEach((key, index) => {
                setTimeout(() => {
                    const participant = currentWar.participants[key];
                    const actions = ['attack', 'defend', 'retreat'];
                    const weights = [0.6, 0.3, 0.1];
                    const action = weightedRandom(actions, weights);
                    performAction(key, action, true);
                }, index * 300);
            });
        }

        function updateRankings() {
            const tbody = document.getElementById('rankingsBody');
            tbody.innerHTML = '';
            
            const sorted = Object.entries(countries).sort((a, b) => b[1].power - a[1].power);
            
            sorted.forEach(([name, data], index) => {
                const row = tbody.insertRow();
                
                let medal = '';
                if (index === 0) medal = 'ğŸ¥‡';
                else if (index === 1) medal = 'ğŸ¥ˆ';
                else if (index === 2) medal = 'ğŸ¥‰';
                else medal = index + 1;
                
                let status = 'ğŸ•Šï¸';
                if (currentWar) {
                    const isInWar = Object.values(currentWar.participants).some(p => 
                        p.country === name && p.isActive
                    );
                    if (isInWar) {
                        status = currentWar.isCivilWar ? 'âš”ï¸ğŸ†šâš”ï¸ ××œ×—××ª ××–×¨×—×™×' : 'âš”ï¸ ×‘××œ×—××”';
                    }
                }
                
                row.innerHTML = `
                    <td class="rank-medal">${medal}</td>
                    <td>${data.flag} ${name}</td>
                    <td>${data.power}</td>
                    <td>${status}</td>
                `;
            });
        }

        function updateStats() {
            document.getElementById('activeWars').textContent = currentWar ? '1' : '0';
            document.getElementById('totalTurns').textContent = totalTurnsAllWars;
            const inWar = currentWar ? currentWar.activeCount : 0;
            document.getElementById('countriesAtWar').textContent = inWar;
            document.getElementById('countriesAtPeace').textContent = 24 - inWar;
        }

        function toggleAutoBattle() {
            const enabled = document.getElementById('autoBattle').checked;
            const indicator = document.getElementById('autoBattleIndicator');
            
            if (enabled && currentWar) {
                startAutoBattle();
                indicator.style.display = 'block';
            } else {
                stopAutoBattle();
                indicator.style.display = 'none';
            }
        }

        function startAutoBattle() {
            if (!currentWar) return;
            
            const speed = parseInt(document.getElementById('battleSpeed').value);
            
            autoBattleInterval = setInterval(() => {
                if (!currentWar || currentWar.activeCount <= 1) {
                    stopAutoBattle();
                    return;
                }
                
                // Get random active participant
                const activeKeys = Object.keys(currentWar.participants).filter(key => 
                    currentWar.participants[key].isActive
                );
                
                if (activeKeys.length > 0) {
                    const randomKey = activeKeys[Math.floor(Math.random() * activeKeys.length)];
                    const actions = ['attack', 'defend', 'retreat'];
                    const weights = [0.6, 0.3, 0.1];
                    const action = weightedRandom(actions, weights);
                    
                    performAction(randomKey, action, true);
                }
            }, speed);
        }

        function stopAutoBattle() {
            if (autoBattleInterval) {
                clearInterval(autoBattleInterval);
                autoBattleInterval = null;
            }
            document.getElementById('autoBattleIndicator').style.display = 'none';
        }

        function weightedRandom(items, weights) {
            let total = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * total;
            
            for (let i = 0; i < items.length; i++) {
                if (random < weights[i]) return items[i];
                random -= weights[i];
            }
            return items[0];
        }

        function togglePowerBars() {
            updateWarStatus();
        }

        function renderMap() {
            const map = document.getElementById('worldMap');
            map.innerHTML = '';

            Object.entries(countries).forEach(([name, data]) => {
                const marker = document.createElement('div');
                marker.className = 'country-marker';
                marker.style.left = `${data.x}%`;
                marker.style.top = `${data.y}%`;
                marker.style.background = data.color;
                marker.innerHTML = data.flag;
                marker.title = name;
                
                marker.addEventListener('click', () => showCountryInfo(name));
                marker.addEventListener('mouseenter', (e) => showTooltip(e, name));
                marker.addEventListener('mouseleave', hideTooltip);

                if (currentWar) {
                    const isInWar = Object.values(currentWar.participants).some(p => 
                        p.country === name && p.isActive
                    );
                    if (isInWar) {
                        marker.classList.add(currentWar.isCivilWar ? 'civil-war' : 'at-war');
                    }
                }

                map.appendChild(marker);
            });

            renderAttackLines();
        }

        function renderAttackLines() {
            const map = document.getElementById('worldMap');
            attackLines.forEach(line => line.remove());
            attackLines = [];

            if (currentWar && document.getElementById('animatedLines').checked) {
                const mapRect = map.getBoundingClientRect();
                
                // For civil war, create circular attack pattern
                if (currentWar.isCivilWar) {
                    const activeParticipants = Object.values(currentWar.participants).filter(p => p.isActive);
                    if (activeParticipants.length > 0) {
                        const country = activeParticipants[0].country;
                        const countryData = countries[country];
                        const centerX = (countryData.x / 100) * mapRect.width;
                        const centerY = (countryData.y / 100) * mapRect.height;
                        
                        // Create explosion-like lines from center
                        for (let angle = 0; angle < 360; angle += 45) {
                            const rad = (angle * Math.PI) / 180;
                            const length = 80;
                            const endX = centerX + Math.cos(rad) * length;
                            const endY = centerY + Math.sin(rad) * length;
                            
                            const line = document.createElement('div');
                            line.className = 'attack-line civil-war-line';
                            line.style.position = 'absolute';
                            line.style.left = centerX + 'px';
                            line.style.top = centerY + 'px';
                            line.style.width = length + 'px';
                            line.style.height = '3px';
                            line.style.transformOrigin = '0 50%';
                            line.style.transform = `rotate(${angle}deg)`;
                            line.style.animation = 'attackPulse 0.8s infinite';
                            
                            map.appendChild(line);
                            attackLines.push(line);
                        }
                    }
                } else {
                    // Regular multi-participant war - draw lines between all participants
                    const activeParticipants = Object.entries(currentWar.participants)
                        .filter(([key, p]) => p.isActive)
                        .map(([key, p]) => ({ key, country: p.country }));
                    
                    for (let i = 0; i < activeParticipants.length; i++) {
                        for (let j = i + 1; j < activeParticipants.length; j++) {
                            const country1 = countries[activeParticipants[i].country];
                            const country2 = countries[activeParticipants[j].country];
                            
                            const x1 = (country1.x / 100) * mapRect.width;
                            const y1 = (country1.y / 100) * mapRect.height;
                            const x2 = (country2.x / 100) * mapRect.width;
                            const y2 = (country2.y / 100) * mapRect.height;
                            
                            const dx = x2 - x1;
                            const dy = y2 - y1;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                            
                            const line = document.createElement('div');
                            line.className = 'attack-line';
                            line.style.position = 'absolute';
                            line.style.left = x1 + 'px';
                            line.style.top = y1 + 'px';
                            line.style.width = distance + 'px';
                            line.style.height = '3px';
                            line.style.transformOrigin = '0 50%';
                            line.style.transform = `rotate(${angle}deg)`;
                            line.style.animation = 'attackPulse 1s infinite';
                            
                            map.appendChild(line);
                            attackLines.push(line);
                        }
                    }
                }
            }
        }

        function showTooltip(e, country) {
            const tooltip = document.getElementById('tooltip');
            const data = countries[country];
            tooltip.innerHTML = `<strong>${data.flag} ${country}</strong><br>×›×•×—: ${data.power}/100`;
            tooltip.style.display = 'block';
            tooltip.style.left = e.pageX + 10 + 'px';
            tooltip.style.top = e.pageY + 10 + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').style.display = 'none';
        }

        function showCountryInfo(country) {
            const data = countries[country];
            const info = document.getElementById('countryInfo');
            
            let status = '×©×œ×•×•×”';
            if (currentWar) {
                const isInWar = Object.values(currentWar.participants).some(p => 
                    p.country === country && p.isActive
                );
                if (isInWar) {
                    status = currentWar.isCivilWar ? '××œ×—××ª ××–×¨×—×™×!' : '×‘××œ×—××”';
                }
            }
            
            info.innerHTML = `
                <div style="font-size: 24px; margin-bottom: 10px;">${data.flag}</div>
                <strong>${country}</strong><br>
                <strong>×›×•×— ×¦×‘××™:</strong> ${data.power}/100<br>
                <strong>×¡×˜×˜×•×¡:</strong> ${status}
            `;
        }

        function updateWarStatus() {
            if (!currentWar) return;

            const status = document.getElementById('warStatus');
            let html = `<strong>×¡×™×‘×•×‘ ${warTurns}</strong><br>`;
            
            if (currentWar.isCivilWar) {
                html += `<div style="text-align: center; color: #ff00ff; font-weight: bold; margin: 10px 0;">ğŸ’¥ ××œ×—××ª ××–×¨×—×™× ğŸ’¥</div>`;
                status.classList.add('civil-war-info');
            } else {
                status.classList.remove('civil-war-info');
            }
            
            Object.entries(currentWar.participants).forEach(([key, participant], index) => {
                if (!participant.isActive) return;
                
                const displayName = currentWar.isCivilWar ? key : participant.country;
                const flag = countries[participant.country].flag;
                const maxPower = countries[participant.country].power;
                const percent = Math.max(0, (participant.strength / maxPower * 100));
                
                html += `
                    <div style="margin: 10px 0;">
                        <div>${flag} ${displayName}</div>
                        <div class="power-bar">
                            <div class="power-fill participant-${(index % 6) + 1}" style="width: ${percent}%">
                                ${percent.toFixed(0)}%
                            </div>
                        </div>
                    </div>
                `;
            });
            
            status.innerHTML = html;
        }

        function checkWarEnd() {
            if (!currentWar) return;

            if (currentWar.activeCount <= 1) {
                const winner = Object.entries(currentWar.participants).find(([key, p]) => p.isActive);
                if (winner) {
                    endWar(winner[0]);
                }
            }
        }

        function endWar(winnerKey) {
            const winner = currentWar.participants[winnerKey];
            const displayName = currentWar.isCivilWar ? winnerKey : winner.country;
            const flag = countries[winner.country].flag;
            
            if (currentWar.isCivilWar) {
                addLog(`ğŸ† ${flag} ${displayName} × ×™×¦×— ×‘××œ×—××ª ×”××–×¨×—×™× ×œ××—×¨ ${warTurns} ×¡×™×‘×•×‘×™×!`, true);
                alert(`ğŸ† ${displayName} × ×™×¦×— ×‘××œ×—××ª ×”××–×¨×—×™×!\n\n×”××œ×—××” × ××©×›×” ${warTurns} ×¡×™×‘×•×‘×™×`);
            } else {
                addLog(`ğŸ† ${flag} ${displayName} × ×™×¦×— ×‘××œ×—××” ×”×¨×‘-××©×ª×ª×¤×™×ª ×œ××—×¨ ${warTurns} ×¡×™×‘×•×‘×™×!`);
                alert(`ğŸ† ${displayName} × ×™×¦×— ×‘××œ×—××”!\n\n×”××œ×—××” × ××©×›×” ${warTurns} ×¡×™×‘×•×‘×™×`);
            }
            
            stopAutoBattle();
            currentWar = null;
            document.getElementById('warControls').style.display = 'none';
            updateRankings();
            updateStats();
            renderMap();
        }

        function proposePeace() {
            if (!currentWar) {
                alert('××™×Ÿ ××œ×—××” ×¤×¢×™×œ×”');
                return;
            }

            if (Math.random() < 0.5) {
                addLog(`ğŸ•Šï¸ ×”×¦×¢×ª ×”×©×œ×•× ×”×ª×§×‘×œ×”! ×›×œ ×”××©×ª×ª×¤×™× ××¡×›×™××™× ×œ×©×œ×•×`, currentWar.isCivilWar);
                alert('×”×¦×¢×ª ×”×©×œ×•× ×”×ª×§×‘×œ×”! ×”××œ×—××” ×”×¡×ª×™×™××”');
                stopAutoBattle();
                currentWar = null;
                document.getElementById('warControls').style.display = 'none';
                updateRankings();
                updateStats();
                renderMap();
            } else {
                addLog(`âŒ ×”×¦×¢×ª ×”×©×œ×•× × ×“×—×ª×”! ×”×œ×—×™××” × ××©×›×ª`, currentWar.isCivilWar);
            }
        }

        function surrender() {
            if (!currentWar) {
                alert('××™×Ÿ ××œ×—××” ×¤×¢×™×œ×”');
                return;
            }

            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©××ª×” ×¨×•×¦×” ×œ×”×›×¨×™×– ×¢×œ ×›× ×™×¢×” ×›×œ×œ×™×ª?')) {
                const activeParticipants = Object.entries(currentWar.participants)
                    .filter(([key, p]) => p.isActive);
                
                if (activeParticipants.length > 0) {
                    const winner = activeParticipants[0];
                    const displayName = currentWar.isCivilWar ? winner[0] : winner[1].country;
                    addLog(`ğŸ³ï¸ ×›× ×™×¢×” ×›×œ×œ×™×ª! ${displayName} ×× ×¦×—!`, currentWar.isCivilWar);
                }
                
                stopAutoBattle();
                currentWar = null;
                document.getElementById('warControls').style.display = 'none';
                updateRankings();
                updateStats();
                renderMap();
            }
        }

        function addLog(message, isCivilWar = false) {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry' + (isCivilWar ? ' civil-war' : '');
            const time = new Date().toLocaleTimeString('he-IL');
            entry.innerHTML = `<strong>[${time}]</strong> ${message}`;
            log.insertBefore(entry, log.firstChild);
        }

        // Initialize game
        init();
    </script>
</body>
</html>
