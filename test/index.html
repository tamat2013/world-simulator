<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×¡×™××•×œ×˜×•×¨ ××œ×—××•×ª ×¢×•×œ××™</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        .game-grid {
            display: grid;
            grid-template-columns: 350px 1fr 300px;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1400px) {
            .game-grid {
                grid-template-columns: 1fr;
            }
        }

        .panel {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .map-container {
            position: relative;
            background: #1a1a2e;
            border-radius: 15px;
            padding: 20px;
            min-height: 600px;
        }

        #worldMap {
            width: 100%;
            height: 600px;
            background: linear-gradient(to bottom, #87CEEB 0%, #E0F6FF 50%, #90EE90 100%);
            border-radius: 10px;
            position: relative;
            overflow: hidden;
            border: 3px solid #444;
        }

        .country-marker {
            position: absolute;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .country-marker:hover {
            transform: scale(1.2);
            z-index: 10;
        }

        .country-marker.at-war {
            animation: pulse 1s infinite;
            border-color: #ff0000;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .attack-line {
            position: absolute;
            background: linear-gradient(90deg, #ff0000, #ff6600, #ffaa00);
            pointer-events: none;
            box-shadow: 0 0 10px #ff0000;
        }

        .attack-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
            pointer-events: none;
        }

        @keyframes attackPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }

        .control-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .section {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 10px;
        }

        .section h3 {
            margin-bottom: 10px;
            color: #ffd700;
            border-bottom: 2px solid #ffd700;
            padding-bottom: 5px;
        }

        select, button {
            width: 100%;
            padding: 12px;
            margin: 5px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        select {
            background: #fff;
            color: #333;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button.attack {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        button.defend {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        button.retreat {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        button.peace {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
            font-size: 14px;
            padding: 8px;
        }

        button.surrender {
            background: linear-gradient(135deg, #2c3e50, #000000);
            font-size: 14px;
            padding: 8px;
        }

        .diplomacy-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 10px;
        }

        .diplomacy-column {
            display: flex;
            flex-direction: column;
            gap: 5px;
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 8px;
        }

        .diplomacy-column h4 {
            font-size: 12px;
            text-align: center;
            color: #ccc;
        }

        .war-info {
            background: rgba(255, 0, 0, 0.1);
            border: 2px solid #ff6666;
            border-radius: 10px;
            padding: 15px;
            margin-top: 10px;
        }

        .power-bar {
            width: 100%;
            height: 30px;
            background: #333;
            border-radius: 15px;
            overflow: hidden;
            margin: 10px 0;
            position: relative;
        }

        .power-fill {
            height: 100%;
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }

        .power-fill.attacker {
            background: linear-gradient(90deg, #ff0000, #ff6600);
            float: right;
        }

        .power-fill.defender {
            background: linear-gradient(90deg, #0066ff, #00ccff);
        }

        .status-text {
            text-align: center;
            font-size: 14px;
            margin-top: 5px;
        }

        .log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 10px;
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-entry:last-child {
            border-bottom: none;
        }

        .country-info {
            background: rgba(0, 0, 0, 0.3);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 14px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            display: none;
        }

        .ai-action {
            background: rgba(255, 215, 0, 0.2);
            border: 2px solid #ffd700;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .rankings-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .rankings-table th {
            background: rgba(255, 215, 0, 0.3);
            padding: 8px;
            text-align: right;
            border-bottom: 2px solid #ffd700;
        }

        .rankings-table td {
            padding: 6px 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .rankings-table tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .rank-medal {
            font-size: 16px;
        }

        .settings-group {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 8px;
        }

        .settings-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
            color: #ffd700;
        }

        .settings-group input[type="range"] {
            width: 100%;
            margin: 5px 0;
        }

        .settings-group input[type="checkbox"] {
            margin-left: 5px;
        }

        .speed-display {
            text-align: center;
            font-weight: bold;
            color: #00ff00;
        }

        .auto-battle-indicator {
            background: linear-gradient(135deg, #ff6b6b, #ff8e53);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            animation: pulse 1s infinite;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸŒ ×¡×™××•×œ×˜×•×¨ ××œ×—××•×ª ×¢×•×œ××™ ğŸŒ</h1>
        
        <div class="game-grid">
            <div class="control-panel">
                <div class="panel section">
                    <h3>âš™ï¸ ×”×’×“×¨×•×ª ××©×—×§</h3>
                    
                    <div class="settings-group">
                        <label>××”×™×¨×•×ª ×§×¨×‘:</label>
                        <input type="range" id="battleSpeed" min="500" max="5000" value="2000" step="100">
                        <div class="speed-display" id="speedDisplay">2.0 ×©× ×™×•×ª</div>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="autoBattle" onchange="toggleAutoBattle()">
                            ×§×¨×‘ ××•×˜×•××˜×™
                        </label>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="showPowerBars" checked onchange="togglePowerBars()">
                            ×”×¦×’ ××“×™ ×›×•×—
                        </label>
                    </div>

                    <div class="settings-group">
                        <label>
                            <input type="checkbox" id="animatedLines" checked onchange="renderMap()">
                            ×§×•×•×™ ×”×ª×§×¤×” ××•× ×¤×©×™×
                        </label>
                    </div>

                    <div id="autoBattleIndicator" style="display: none;" class="auto-battle-indicator">
                        âš”ï¸ ×§×¨×‘ ××•×˜×•××˜×™ ×¤×¢×™×œ âš”ï¸
                    </div>
                </div>

                <div class="panel section">
                    <h3>âš”ï¸ ×‘×—×¨ ××“×™× ×•×ª</h3>
                    <label>×ª×•×§×£:</label>
                    <select id="attackerSelect"></select>
                    
                    <label>× ×ª×§×£:</label>
                    <select id="defenderSelect"></select>
                    
                    <button class="attack" onclick="startWar()">ğŸ”¥ ×”×ª×—×œ ××œ×—××”</button>
                </div>

                <div class="panel section" id="warControls" style="display: none;">
                    <h3>ğŸ® ×¤×§×•×“×•×ª ×§×¨×‘ (×ª×•×§×£)</h3>
                    <button class="attack" onclick="performAction('attack')">âš”ï¸ ×”×ª×§×£</button>
                    <button class="defend" onclick="performAction('defend')">ğŸ›¡ï¸ ×”×’×Ÿ</button>
                    <button class="retreat" onclick="performAction('retreat')">ğŸƒ × ×¡×•×’</button>
                    
                    <div class="war-info" id="warStatus"></div>
                </div>

                <div class="panel section" id="diplomacyPanel" style="display: none;">
                    <h3>ğŸ•Šï¸ ×“×™×¤×œ×•××˜×™×”</h3>
                    <div class="diplomacy-grid">
                        <div class="diplomacy-column">
                            <h4 id="labelAttackerDiplomacy">×ª×•×§×£</h4>
                            <button class="peace" onclick="proposePeace('attacker')">â˜®ï¸ ×”×¦×¢ ×©×œ×•×</button>
                            <button class="surrender" onclick="surrender('attacker')">ğŸ³ï¸ ×›× ×™×¢×”</button>
                        </div>
                        <div class="diplomacy-column">
                            <h4 id="labelDefenderDiplomacy">××’×Ÿ</h4>
                            <button class="peace" onclick="proposePeace('defender')">â˜®ï¸ ×”×¦×¢ ×©×œ×•×</button>
                            <button class="surrender" onclick="surrender('defender')">ğŸ³ï¸ ×›× ×™×¢×”</button>
                        </div>
                    </div>
                    
                    <div class="ai-action" id="aiActions" style="display: none;"></div>
                </div>

                <div class="panel section">
                    <h3>ğŸ“Š ××™×“×¢ ×¢×œ ××“×™× ×”</h3>
                    <div class="country-info" id="countryInfo">
                        ×‘×—×¨ ××“×™× ×” ×‘××¤×” ×œ×¨××•×ª ××™×“×¢
                    </div>
                </div>
            </div>

            <div class="panel">
                <div class="map-container">
                    <h3 style="margin-bottom: 15px;">ğŸ—ºï¸ ××¤×ª ×”×¢×•×œ×</h3>
                    <div id="worldMap"></div>
                </div>

                <div class="section" style="margin-top: 20px;">
                    <h3>ğŸ“œ ×™×•××Ÿ ××™×¨×•×¢×™×</h3>
                    <div class="log" id="eventLog"></div>
                </div>
            </div>

            <div class="control-panel">
                <div class="panel section">
                    <h3>ğŸ† ×“×™×¨×•×’ ××“×™× ×•×ª</h3>
                    <div style="max-height: 500px; overflow-y: auto;">
                        <table class="rankings-table" id="rankingsTable">
                            <thead>
                                <tr>
                                    <th>×“×™×¨×•×’</th>
                                    <th>××“×™× ×”</th>
                                    <th>×›×•×—</th>
                                    <th>×¡×˜×˜×•×¡</th>
                                </tr>
                            </thead>
                            <tbody id="rankingsBody"></tbody>
                        </table>
                    </div>
                </div>

                <div class="panel section">
                    <h3>ğŸ“ˆ ×¡×˜×˜×™×¡×˜×™×§×•×ª</h3>
                    <div class="country-info">
                        <div id="gameStats">
                            <strong>××œ×—××•×ª ×¤×¢×™×œ×•×ª:</strong> <span id="activeWars">0</span><br>
                            <strong>×¡×”"×› ×¡×™×‘×•×‘×™×:</strong> <span id="totalTurns">0</span><br>
                            <strong>××“×™× ×•×ª ×‘××œ×—××”:</strong> <span id="countriesAtWar">0</span><br>
                            <strong>××“×™× ×•×ª ×‘×©×œ×•×:</strong> <span id="countriesAtPeace">24</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        const countries = {
            '××¨×”"×‘': { power: 100, flag: 'ğŸ‡ºğŸ‡¸', x: 15, y: 35, color: '#1e40af' },
            '×¡×™×Ÿ': { power: 95, flag: 'ğŸ‡¨ğŸ‡³', x: 75, y: 40, color: '#dc2626' },
            '×¨×•×¡×™×”': { power: 90, flag: 'ğŸ‡·ğŸ‡º', x: 60, y: 25, color: '#16a34a' },
            '×”×•×“×•': { power: 75, flag: 'ğŸ‡®ğŸ‡³', x: 70, y: 50, color: '#ea580c' },
            '×‘×¨×™×˜× ×™×”': { power: 70, flag: 'ğŸ‡¬ğŸ‡§', x: 45, y: 28, color: '#7c3aed' },
            '×¦×¨×¤×ª': { power: 68, flag: 'ğŸ‡«ğŸ‡·', x: 47, y: 32, color: '#0891b2' },
            '×’×¨×× ×™×”': { power: 67, flag: 'ğŸ‡©ğŸ‡ª', x: 50, y: 30, color: '#4338ca' },
            '×™×¤×Ÿ': { power: 65, flag: 'ğŸ‡¯ğŸ‡µ', x: 85, y: 38, color: '#be123c' },
            '×“×¨×•× ×§×•×¨×™××”': { power: 60, flag: 'ğŸ‡°ğŸ‡·', x: 82, y: 42, color: '#059669' },
            '××™×˜×œ×™×”': { power: 55, flag: 'ğŸ‡®ğŸ‡¹', x: 50, y: 36, color: '#0284c7' },
            '×˜×•×¨×§×™×”': { power: 53, flag: 'ğŸ‡¹ğŸ‡·', x: 55, y: 38, color: '#dc2626' },
            '×‘×¨×–×™×œ': { power: 50, flag: 'ğŸ‡§ğŸ‡·', x: 30, y: 65, color: '#16a34a' },
            '×™×©×¨××œ': { power: 48, flag: 'ğŸ‡®ğŸ‡±', x: 54, y: 45, color: '#2563eb' },
            '××™×¨××Ÿ': { power: 45, flag: 'ğŸ‡®ğŸ‡·', x: 62, y: 43, color: '#15803d' },
            '××¦×¨×™×': { power: 42, flag: 'ğŸ‡ªğŸ‡¬', x: 53, y: 48, color: '#b91c1c' },
            '×¡×¤×¨×“': { power: 40, flag: 'ğŸ‡ªğŸ‡¸', x: 44, y: 38, color: '#eab308' },
            '××•×¡×˜×¨×œ×™×”': { power: 38, flag: 'ğŸ‡¦ğŸ‡º', x: 82, y: 75, color: '#0891b2' },
            '×§× ×“×”': { power: 36, flag: 'ğŸ‡¨ğŸ‡¦', x: 18, y: 22, color: '#dc2626' },
            '×¢×¨×‘ ×”×¡×¢×•×“×™×ª': { power: 35, flag: 'ğŸ‡¸ğŸ‡¦', x: 58, y: 48, color: '#16a34a' },
            '××§×¡×™×§×•': { power: 32, flag: 'ğŸ‡²ğŸ‡½', x: 12, y: 48, color: '#15803d' },
            '××¨×’× ×˜×™× ×”': { power: 30, flag: 'ğŸ‡¦ğŸ‡·', x: 28, y: 78, color: '#0891b2' },
            '×“×¨×•× ××¤×¨×™×§×”': { power: 28, flag: 'ğŸ‡¿ğŸ‡¦', x: 52, y: 75, color: '#eab308' },
            '××™× ×“×•× ×–×™×”': { power: 25, flag: 'ğŸ‡®ğŸ‡©', x: 78, y: 62, color: '#dc2626' },
            '×¤×§×™×¡×˜×Ÿ': { power: 23, flag: 'ğŸ‡µğŸ‡°', x: 68, y: 45, color: '#16a34a' }
        };

        let currentWar = null;
        let attackLines = [];
        let warTurns = 0;
        let autoBattleInterval = null;
        let totalTurnsAllWars = 0;

        function init() {
            populateSelects();
            renderMap();
            updateRankings();
            updateStats();
            addLog('×”××©×—×§ ××•×›×Ÿ! ×‘×—×¨ ××“×™× ×•×ª ×›×“×™ ×œ×”×ª×—×™×œ ××œ×—××”');
            
            document.getElementById('battleSpeed').addEventListener('input', function() {
                const speed = this.value / 1000;
                document.getElementById('speedDisplay').textContent = speed.toFixed(1) + ' ×©× ×™×•×ª';
                if (autoBattleInterval) {
                    stopAutoBattle();
                    startAutoBattle();
                }
            });
        }

        function updateRankings() {
            const tbody = document.getElementById('rankingsBody');
            tbody.innerHTML = '';
            const sorted = Object.entries(countries).sort((a, b) => b[1].power - a[1].power);
            sorted.forEach(([name, data], index) => {
                const row = tbody.insertRow();
                let medal = index < 3 ? ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'][index] : index + 1;
                let status = 'ğŸ•Šï¸';
                if (currentWar) {
                    if (currentWar.attacker === name) status = 'âš”ï¸ ×ª×•×§×£';
                    else if (currentWar.defender === name) status = 'ğŸ›¡ï¸ ××•×ª×§×£';
                }
                row.innerHTML = `<td class="rank-medal">${medal}</td><td>${data.flag} ${name}</td><td>${data.power}</td><td>${status}</td>`;
            });
        }

        function updateStats() {
            document.getElementById('activeWars').textContent = currentWar ? '1' : '0';
            document.getElementById('totalTurns').textContent = totalTurnsAllWars;
            document.getElementById('countriesAtWar').textContent = currentWar ? '2' : '0';
            document.getElementById('countriesAtPeace').textContent = currentWar ? '22' : '24';
        }

        function toggleAutoBattle() {
            const enabled = document.getElementById('autoBattle').checked;
            if (enabled && currentWar) startAutoBattle();
            else stopAutoBattle();
        }

        function startAutoBattle() {
            if (!currentWar) return;
            const speed = parseInt(document.getElementById('battleSpeed').value);
            document.getElementById('autoBattleIndicator').style.display = 'block';
            autoBattleInterval = setInterval(() => {
                if (!currentWar) { stopAutoBattle(); return; }
                const actions = ['attack', 'defend', 'retreat'];
                const action = weightedRandom(actions, [0.6, 0.3, 0.1]);
                performAction(action, true);
            }, speed);
        }

        function stopAutoBattle() {
            if (autoBattleInterval) { clearInterval(autoBattleInterval); autoBattleInterval = null; }
            document.getElementById('autoBattleIndicator').style.display = 'none';
        }

        function weightedRandom(items, weights) {
            let total = weights.reduce((a, b) => a + b, 0);
            let random = Math.random() * total;
            for (let i = 0; i < items.length; i++) {
                if (random < weights[i]) return items[i];
                random -= weights[i];
            }
            return items[0];
        }

        function togglePowerBars() {
            updateWarStatus();
        }

        function populateSelects() {
            const aS = document.getElementById('attackerSelect');
            const dS = document.getElementById('defenderSelect');
            Object.keys(countries).sort().forEach(country => {
                aS.add(new Option(`${countries[country].flag} ${country} (×›×•×—: ${countries[country].power})`, country));
                dS.add(new Option(`${countries[country].flag} ${country} (×›×•×—: ${countries[country].power})`, country));
            });
        }

        function renderMap() {
            const map = document.getElementById('worldMap');
            map.innerHTML = '';
            Object.entries(countries).forEach(([name, data]) => {
                const marker = document.createElement('div');
                marker.className = 'country-marker';
                marker.style.left = `${data.x}%`;
                marker.style.top = `${data.y}%`;
                marker.style.background = data.color;
                marker.innerHTML = data.flag;
                marker.addEventListener('click', () => showCountryInfo(name));
                marker.addEventListener('mouseenter', (e) => showTooltip(e, name));
                marker.addEventListener('mouseleave', hideTooltip);
                if (currentWar && (currentWar.attacker === name || currentWar.defender === name)) marker.classList.add('at-war');
                map.appendChild(marker);
            });
            renderAttackLines();
        }

        function renderAttackLines() {
            const map = document.getElementById('worldMap');
            attackLines.forEach(line => line.remove());
            attackLines = [];
            if (currentWar && document.getElementById('animatedLines').checked) {
                const attacker = countries[currentWar.attacker];
                const defender = countries[currentWar.defender];
                const mapRect = map.getBoundingClientRect();
                const x1 = (attacker.x / 100) * mapRect.width;
                const y1 = (attacker.y / 100) * mapRect.height;
                const x2 = (defender.x / 100) * mapRect.width;
                const y2 = (defender.y / 100) * mapRect.height;
                for (let i = 0; i < 3; i++) {
                    const line = document.createElement('div');
                    line.className = 'attack-line';
                    const dx = x2 - x1, dy = y2 - y1, dist = Math.sqrt(dx*dx+dy*dy), angle = Math.atan2(dy, dx)*180/Math.PI;
                    line.style.left = x1 + 'px';
                    line.style.top = (y1 - 2 + i * 3) + 'px';
                    line.style.width = dist + 'px';
                    line.style.height = '3px';
                    line.style.transformOrigin = '0 50%';
                    line.style.transform = `rotate(${angle}deg)`;
                    line.style.animation = `attackPulse ${1 + i * 0.2}s infinite`;
                    map.appendChild(line);
                    attackLines.push(line);
                }
            }
        }

        function showTooltip(e, country) {
            const t = document.getElementById('tooltip');
            t.innerHTML = `<strong>${countries[country].flag} ${country}</strong><br>×›×•×—: ${countries[country].power}/100`;
            t.style.display = 'block'; t.style.left = e.pageX + 10 + 'px'; t.style.top = e.pageY + 10 + 'px';
        }

        function hideTooltip() { document.getElementById('tooltip').style.display = 'none'; }

        function showCountryInfo(country) {
            const data = countries[country];
            let status = '×©×œ×•×•×”';
            if (currentWar) {
                if (currentWar.attacker === country) status = '×ª×•×§×£';
                else if (currentWar.defender === country) status = '××•×ª×§×£';
            }
            document.getElementById('countryInfo').innerHTML = `
                <div style="font-size: 24px; margin-bottom: 10px;">${data.flag}</div>
                <strong>${country}</strong><br><strong>×›×•×— ×¦×‘××™:</strong> ${data.power}/100<br><strong>×¡×˜×˜×•×¡:</strong> ${status}
            `;
        }

        function startWar() {
            const attacker = document.getElementById('attackerSelect').value;
            const defender = document.getElementById('defenderSelect').value;
            if (attacker === defender) { alert('××“×™× ×” ×œ× ×™×›×•×œ×” ×œ×ª×§×•×£ ××ª ×¢×¦××”!'); return; }
            currentWar = {
                attacker: attacker, defender: defender,
                attackerStrength: countries[attacker].power, defenderStrength: countries[defender].power,
                attackerMorale: 100, defenderMorale: 100
            };
            warTurns = 0;
            document.getElementById('warControls').style.display = 'block';
            document.getElementById('diplomacyPanel').style.display = 'block';
            document.getElementById('labelAttackerDiplomacy').textContent = `${countries[attacker].flag} ${attacker}`;
            document.getElementById('labelDefenderDiplomacy').textContent = `${countries[defender].flag} ${defender}`;
            updateWarStatus(); updateRankings(); updateStats(); renderMap();
            addLog(`ğŸ”¥ ××œ×—××” ×”×—×œ×”! ${attacker} ×ª×•×§×£ ××ª ${defender}`);
            if (document.getElementById('autoBattle').checked) startAutoBattle();
        }

        function performAction(action, isAuto = false) {
            if (!currentWar) return;
            warTurns++; totalTurnsAllWars++;
            const attacker = currentWar.attacker;
            const defender = currentWar.defender;
            const powerRatio = currentWar.attackerStrength / currentWar.defenderStrength;
            let damage = 0, counterDamage = 0;

            if (action === 'attack') {
                damage = 5 + Math.random() * 10 * powerRatio;
                counterDamage = 3 + Math.random() * 8 * (1/powerRatio);
                currentWar.defenderStrength -= damage; currentWar.attackerStrength -= counterDamage;
                addLog(`âš”ï¸ ${attacker} ×ª×•×§×£! × ×’×¨× ${damage.toFixed(1)} × ×–×§ ×œ${defender}, ×•×¡×¤×’ ${counterDamage.toFixed(1)} × ×–×§`);
            } else if (action === 'defend') {
                counterDamage = 2 + Math.random() * 5 * (1/powerRatio);
                currentWar.attackerStrength -= counterDamage; currentWar.defenderMorale += 5;
                addLog(`ğŸ›¡ï¸ ${attacker} ××ª××§×“ ×‘×”×’× ×”. × ×¡×¤×’×• ×¤×—×•×ª ××‘×™×“×•×ª`);
            } else if (action === 'retreat') {
                damage = 8 + Math.random() * 12;
                currentWar.attackerStrength -= damage; currentWar.attackerMorale -= 15;
                addLog(`ğŸƒ ${attacker} × ×¡×•×’ ×•×¡×¤×’ ××© ×‘×–××Ÿ ×”× ×¡×™×’×”`);
            }

            if (!isAuto) aiDefenderAction();
            else aiDefenderAction();

            checkWarEnd(); updateWarStatus(); updateRankings(); updateStats();
        }

        function aiDefenderAction() {
            const powerRatio = currentWar.defenderStrength / currentWar.attackerStrength;
            let action = powerRatio > 1.3 ? 'counterAttack' : (powerRatio < 0.8 ? 'defend' : (Math.random() < 0.5 ? 'counterAttack' : 'defend'));
            let damage = 0;
            if (action === 'counterAttack') {
                damage = 7 + Math.random() * 12 * powerRatio;
                currentWar.attackerStrength -= damage;
                addLog(`ğŸ¤– ${currentWar.defender} ××‘×¦×¢ ××ª×§×¤×ª × ×’×“! × ×’×¨× ${damage.toFixed(1)} × ×–×§`);
            } else {
                currentWar.defenderMorale += 3;
                addLog(`ğŸ¤– ${currentWar.defender} ××ª×‘×¦×¨ ×‘×”×’× ×”`);
            }
        }

        function updateWarStatus() {
            if (!currentWar) return;
            const s = document.getElementById('warStatus');
            const aP = Math.max(0, (currentWar.attackerStrength / countries[currentWar.attacker].power * 100));
            const dP = Math.max(0, (currentWar.defenderStrength / countries[currentWar.defender].power * 100));
            const showBars = document.getElementById('showPowerBars').checked;
            
            s.innerHTML = `<strong>×¡×™×‘×•×‘ ${warTurns}</strong><br>` + 
                (showBars ? `
                <div style="margin: 10px 0;">
                    <div>${countries[currentWar.attacker].flag} ${currentWar.attacker}</div>
                    <div class="power-bar"><div class="power-fill attacker" style="width: ${aP}%">${aP.toFixed(0)}%</div></div>
                </div>
                <div style="margin: 10px 0;">
                    <div>${countries[currentWar.defender].flag} ${currentWar.defender}</div>
                    <div class="power-bar"><div class="power-fill defender" style="width: ${dP}%">${dP.toFixed(0)}%</div></div>
                </div>` : `<p>${currentWar.attacker}: ${aP.toFixed(0)}% | ${currentWar.defender}: ${dP.toFixed(0)}%</p>`) +
                `<div class="status-text">${aP > dP ? currentWar.attacker : currentWar.defender} ××•×‘×™×œ! ğŸ“ˆ</div>`;
        }

        function checkWarEnd() {
            if (!currentWar) return;
            if (currentWar.attackerStrength <= 0) endWar(currentWar.defender);
            else if (currentWar.defenderStrength <= 0) endWar(currentWar.attacker);
        }

        function endWar(winner) {
            const loser = winner === currentWar.attacker ? currentWar.defender : currentWar.attacker;
            addLog(`ğŸ† ${winner} × ×™×¦×— ×‘××œ×—××” × ×’×“ ${loser}!`);
            alert(`ğŸ† ${winner} × ×™×¦×— ×‘××œ×—××”!`);
            stopAutoBattle(); currentWar = null;
            document.getElementById('warControls').style.display = 'none';
            document.getElementById('diplomacyPanel').style.display = 'none';
            updateRankings(); updateStats(); renderMap();
        }

        function proposePeace(side) {
            if (!currentWar) return;
            const proposer = side === 'attacker' ? currentWar.attacker : currentWar.defender;
            const target = side === 'attacker' ? currentWar.defender : currentWar.attacker;
            const pRatio = currentWar.attackerStrength / currentWar.defenderStrength;
            
            // ×¡×™×›×•×™ ×§×‘×œ×” ××‘×•×¡×¡ ×¢×œ ××¦×‘ ×”×›×•×—×•×ª
            let acceptChance = side === 'attacker' ? (pRatio < 0.7 ? 0.8 : 0.3) : (pRatio > 1.3 ? 0.8 : 0.3);
            
            if (Math.random() < acceptChance) {
                addLog(`ğŸ•Šï¸ ${target} ×§×™×‘×œ ××ª ×”×¦×¢×ª ×”×©×œ×•× ×©×œ ${proposer}!`);
                alert('×”×¦×¢×ª ×”×©×œ×•× ×”×ª×§×‘×œ×”!');
                stopAutoBattle(); currentWar = null;
                document.getElementById('warControls').style.display = 'none';
                document.getElementById('diplomacyPanel').style.display = 'none';
                updateRankings(); updateStats(); renderMap();
            } else {
                addLog(`âŒ ${target} ×“×—×” ××ª ×”×¦×¢×ª ×”×©×œ×•× ×©×œ ${proposer}!`);
                const damage = 5 + Math.random() * 5;
                if (side === 'attacker') currentWar.attackerStrength -= damage;
                else currentWar.defenderStrength -= damage;
                updateWarStatus();
            }
        }

        function surrender(side) {
            if (!currentWar) return;
            const loser = side === 'attacker' ? currentWar.attacker : currentWar.defender;
            const winner = side === 'attacker' ? currentWar.defender : currentWar.attacker;
            if (confirm(`×”×× ${loser} ×‘×˜×•×— ×¨×•×¦×” ×œ×”×™×›× ×¢?`)) {
                addLog(`ğŸ³ï¸ ${loser} × ×›× ×¢ ×œ${winner}!`);
                endWar(winner);
            }
        }

        function addLog(message) {
            const log = document.getElementById('eventLog');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<strong>[${new Date().toLocaleTimeString('he-IL')}]</strong> ${message}`;
            log.insertBefore(entry, log.firstChild);
        }

        init();
    </script>
</body>
</html>
